# Clash规则匹配流程分析

## 功能概述
Clash通过规则匹配机制决定如何处理网络请求，将请求路由到合适的代理或直接连接。本文档详细分析了规则匹配的流程、各种规则类型的实现和匹配逻辑。

## 入口方法
`tunnel.Tunnel.match`

## 方法调用树
```
tunnel.Tunnel.match
 ├── Rule.IsMatch (遍历所有规则)
 │   ├── DomainSuffix.IsMatch
 │   ├── DomainKeyword.IsMatch
 │   ├── GEOIP.IsMatch
 │   ├── IPCIDR.IsMatch
 │   └── Final.IsMatch
 └── Proxy selection
```

## 详细业务流程

1. **规则匹配准备**
   - 获取读锁以保证配置读取的线程安全
   - 获取目标地址信息用于规则匹配

2. **规则遍历匹配**
   - 按照配置文件中规则的顺序依次匹配
   - 对每条规则调用`IsMatch()`方法判断是否匹配目标地址
   - 一旦找到匹配的规则就停止遍历

3. **代理选择**
   - 根据匹配规则的`Adapter()`方法获取代理名称
   - 从代理映射中获取对应的代理实例
   - 如果代理不存在则继续查找下一条匹配的规则

4. **日志记录**
   - 记录匹配成功的规则类型和使用的代理
   - 如果没有规则匹配，默认使用DIRECT代理

5. **返回结果**
   - 返回选中的代理实例用于建立连接

## 关键业务规则

- **顺序匹配规则**：按照配置文件中规则的出现顺序进行匹配
- **首次匹配规则**：一旦找到匹配的规则就停止匹配过程
- **默认代理规则**：如果没有规则匹配，默认使用DIRECT代理
- **代理存在性规则**：如果匹配规则对应的代理不存在，则继续查找

## 数据流转

- **输入**：目标地址(`*C.Addr`)
- **处理**：遍历规则列表，调用规则匹配方法
- **输出**：匹配的代理实例(`C.Proxy`)

## 扩展点/分支逻辑

### 规则类型分支
- **DomainSuffix规则**：匹配域名后缀
- **DomainKeyword规则**：匹配域名关键字
- **GEOIP规则**：根据IP地理位置匹配
- **IPCIDR规则**：匹配IP地址段
- **FINAL规则**：最终默认规则（总是匹配）

### 匹配条件分支
- **地址类型检查**：不同规则类型对地址类型有不同要求
- **代理存在性检查**：检查匹配规则对应的代理是否存在

## 各规则类型详细分析

### DomainSuffix规则
1. **匹配条件**
   - 目标地址必须是域名类型
   - 域名以指定后缀结尾

2. **实现逻辑**
   - 检查地址类型是否为域名
   - 使用`strings.HasSuffix`检查域名后缀
   - 特殊处理完全匹配的情况

### DomainKeyword规则
1. **匹配条件**
   - 目标地址必须是域名类型
   - 域名包含指定关键字

2. **实现逻辑**
   - 检查地址类型是否为域名
   - 使用`strings.Contains`检查关键字

### GEOIP规则
1. **匹配条件**
   - 目标地址必须包含IP地址
   - IP地址所属国家与规则指定国家一致

2. **实现逻辑**
   - 检查地址是否包含IP
   - 查询GeoIP数据库获取IP所属国家
   - 比较国家代码

### IPCIDR规则
1. **匹配条件**
   - 目标地址必须包含IP地址
   - IP地址在指定的CIDR范围内

2. **实现逻辑**
   - 检查地址是否包含IP
   - 使用`net.IPNet.Contains`检查IP是否在范围内

### FINAL规则
1. **匹配条件**
   - 总是匹配（作为兜底规则）

2. **实现逻辑**
   - `IsMatch`方法直接返回true

## 外部依赖

- **规则接口**：所有规则类型实现`C.Rule`接口
- **GeoIP库**：`github.com/oschwald/geoip2-golang`用于地理位置查询
- **网络库**：Go标准库`net`包用于IP地址处理
- **字符串处理**：Go标准库`strings`包用于域名处理

## 注意事项

- 规则匹配顺序很重要，会影响最终的代理选择结果
- GEOIP规则需要正确配置GeoIP数据库文件
- IPCIDR规则需要正确理解CIDR表示法
- DomainSuffix规则需要特别处理完全匹配的情况
- FINAL规则通常应该放在配置文件的最后作为兜底规则